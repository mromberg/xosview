#
# Top level Makefile Template for xosview.
#
#
include Makefile.config

#--------------------------------------------------------
# File lists
#--------------------------------------------------------

# build these only if Xft is found (probably will be)
XFT_OBJS = xftfont.o xftgraphics.o


OBJS = \
llist.o \
xwin.o \
x11graphics.o \
x11font.o \
x11pixmap.o \
Xrm.o \
defaultstring.o \
meter.o \
fieldmeter.o \
fieldmeterdecay.o \
fieldmetergraph.o \
bitfieldmeter.o \
bitmeter.o \
clopt.o \
xosview.o \
strutil.o \
fsutil.o \
log.o \
@XFT_OBJS@ \
main.o

# Build these lists from the object files.
CFILES := $(OBJS:.o=.cc)
DEPFILES := $(OBJS:%=.%.d)


#-----------------------------------------------------------------------
# Make rules
#-----------------------------------------------------------------------

all : meterlib xosview

meterlib:
	cd @TOP_SRCDIR@/@host_dir@ && $(MAKE)

@TOP_SRCDIR@/@host_dir@/libmeter.a: meterlib

##  Also use LDFLAGS, which is inherited from the system.
xosview: $(OBJS) @TOP_SRCDIR@/@host_dir@/libmeter.a
	$(CXX) $(LDFLAGS) $(LFLAGS) -o xosview $(OBJS) $(LIBS)


defaultstring.cc: Xdefaults defresources.awk
	@AWK@ -f defresources.awk Xdefaults > defaultstring.cc

distrib: checksource distclean
	echo "FIXME!  Make distrib tarball"

clean :
	@echo "***  Cleaning..."
	cd @host_dir@ && $(MAKE) clean
	cd config && $(MAKE) clean
	rm -f xosview $(OBJS) $(DEPFILES) *~ defaultstring.cc

checksource:
	$(TOP)/chk-src.sh

# Cleans everything except files that will be distributed
distclean: clean
	find . -name "*.o" -exec rm -f {} \;
	rm -f Makefile Makefile.config Makefile.GNU.autodep \
           @host_dir@/Makefile config.cache config.log config.status \
	   Xdefaults xosview.1 config.h
	rm -rf config/autom4te.cache/

# cleans all build items
maintainer-clean: distclean
	rm -f configure config.h.in

# For updating configure.in's checks for C++ header files.
# This finds all uses of '#include <.*>'
headercheck:
	@echo "list of all used C++ headers:"
	@find . -regex ".*\.\(h\|cc\)" -exec grep "include <[^\.]*>" {} \; \
          | sort - | uniq | cut -d " " -f2 - | cut -d "<" -f2 - \
          | cut -d ">" -f1 -

#-----------------------------------------------
# Install related section
#-----------------------------------------------
INSTALL            = @INSTALL@
#-----------------------------------------------
# Gnu Makefile conventions (subset really)
#-----------------------------------------------
PACKAGE_TARNAME = @PACKAGE_TARNAME@
PACKAGE_VERSION = @PACKAGE_VERSION@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
datarootdir = @datarootdir@
datadir = @datadir@
#xapploaddir = ${datarootdir}/X11/app-defaults
xapploaddir = @xapploaddir@
docdir = @docdir@
libdir = @libdir@
mandir = @mandir@
man1dir = $(mandir)/man1
srcdir = @srcdir@

# This seems to be the "accepted" way of inserting paths into the binary
CXXFLAGS += -DXAPPLOADDIR=\"$(xapploaddir)\"

#-------------------------------------------------------
# New install
#-------------------------------------------------------
install: xosview
	$(INSTALL) -d $(bindir) $(man1dir) $(docdir) $(xapploaddir)
	$(INSTALL) -m 0755 $(srcdir)/xosview $(bindir)/xosview
	$(INSTALL) -m 0644 $(srcdir)/xosview.1 $(man1dir)/xosview.1
	$(INSTALL) -m 0644 $(srcdir)/README $(docdir)/README
	$(INSTALL) -m 0644 $(srcdir)/README.linux $(docdir)/README.linux
	$(INSTALL) -m 0644 $(srcdir)/Xdefaults $(xapploaddir)/XOsview



#-------------------------------------------------------


@AUTODEPEND@
